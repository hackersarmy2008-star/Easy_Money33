<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Easy Money</title>
<link rel="stylesheet" href="style.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
.admin-container {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}
.admin-header {
  background: linear-gradient(135deg, #FFD700 0%, #FFC300 100%);
  color: #1f2937;
  padding: 20px;
  border-radius: 15px;
  margin-bottom: 30px;
}
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 30px;
}
.stat-card {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.stat-value {
  font-size: 32px;
  font-weight: bold;
  color: #FFD700;
}
.stat-label {
  color: #666;
  font-size: 14px;
  margin-top: 5px;
}
.data-table {
  background: white;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 30px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  overflow-x: auto;
}
.data-table h3 {
  margin-bottom: 15px;
  color: #FFD700;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th {
  background: #f5f5f5;
  padding: 12px;
  text-align: left;
  font-weight: 600;
  border-bottom: 2px solid #ddd;
}
td {
  padding: 12px;
  border-bottom: 1px solid #eee;
}
tr:hover {
  background: #f9f9f9;
}
.action-btn {
  padding: 6px 12px;
  background: #FFD700;
  color: #1f2937;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  margin-right: 5px;
  font-weight: 600;
}
.action-btn.approve {
  background: #28a745;
}
.action-btn.reject {
  background: #dc3545;
}
.action-btn:hover {
  opacity: 0.8;
}
.tab-buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}
.tab-btn {
  padding: 10px 20px;
  background: white;
  border: 2px solid #FFD700;
  color: #FFD700;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}
.tab-btn.active {
  background: #FFD700;
  color: #1f2937;
}
.hidden {
  display: none;
}
.badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}
.badge.pending {
  background: #ffc107;
  color: #000;
}
.badge.completed {
  background: #28a745;
  color: white;
}
.badge.verification_pending {
  background: #ff9800;
  color: white;
}
</style>
</head>
<body>
<script>
  const token = localStorage.getItem('authToken');
  if (!token) {
    window.location.href = 'admin-login.html';
  } else {
    async function verifyAdminAccess() {
      try {
        const response = await fetch('/api/admin/stats', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          localStorage.clear();
          window.location.href = 'admin-login.html';
        }
      } catch (error) {
        localStorage.clear();
        window.location.href = 'admin-login.html';
      }
    }
    verifyAdminAccess();
  }
</script>

<div class="admin-container">
  <div class="admin-header">
    <h1><i class="bi bi-shield-lock"></i> Admin Dashboard</h1>
    <p>Manage users, transactions, and payments</p>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="totalUsers">0</div>
      <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalBalance">₹0</div>
      <div class="stat-label">Total Balance</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalRecharge">₹0</div>
      <div class="stat-label">Total Recharge</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalWithdraw">₹0</div>
      <div class="stat-label">Total Withdraw</div>
    </div>
  </div>

  <div class="tab-buttons">
    <button class="tab-btn active" onclick="showTab('users')">Users</button>
    <button class="tab-btn" onclick="showTab('transactions')">Transactions</button>
    <button class="tab-btn" onclick="showTab('pending')">Pending Payments</button>
    <button class="tab-btn" onclick="showTab('withdrawals')">Withdrawal Approvals</button>
    <button class="tab-btn" onclick="showTab('upi')">UPI Management</button>
  </div>

  <div id="usersTab" class="data-table">
    <h3><i class="bi bi-people"></i> All Users</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Phone</th>
          <th>Balance</th>
          <th>Total Recharge</th>
          <th>Total Withdraw</th>
          <th>Referral Code</th>
          <th>Registered</th>
        </tr>
      </thead>
      <tbody id="usersTableBody">
        <tr><td colspan="7" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="transactionsTab" class="data-table hidden">
    <h3><i class="bi bi-receipt"></i> All Transactions</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>User ID</th>
          <th>Type</th>
          <th>Amount</th>
          <th>Status</th>
          <th>UPI ID</th>
          <th>UTR Number</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody id="transactionsTableBody">
        <tr><td colspan="8" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="pendingTab" class="data-table hidden">
    <h3><i class="bi bi-clock-history"></i> Pending Payments</h3>
    <table>
      <thead>
        <tr>
          <th>Trans ID</th>
          <th>User ID</th>
          <th>Type</th>
          <th>Amount</th>
          <th>UTR Number</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="pendingTableBody">
        <tr><td colspan="7" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="withdrawalsTab" class="data-table hidden">
    <h3><i class="bi bi-cash-coin"></i> Pending Withdrawal Approvals</h3>
    <p style="margin-bottom:20px; color:#666;">
      Review and approve or deny user withdrawal requests. Approved withdrawals will deduct from user balance.
    </p>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>User Phone</th>
          <th>Amount</th>
          <th>UPI ID</th>
          <th>Requested</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="withdrawalsTableBody">
        <tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="upiTab" class="data-table hidden">
    <h3><i class="bi bi-credit-card"></i> UPI Payment Rotation System</h3>
    <p style="margin-bottom:20px; color:#666;">
      The system automatically rotates through 7 UPI IDs. After 10 successful payments on one UPI, it automatically switches to the next one.
    </p>
    <table>
      <thead>
        <tr>
          <th>Position</th>
          <th>UPI ID</th>
          <th>Successful Payments</th>
          <th>Max Payments</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="upiTableBody">
        <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div style="text-align:center; margin-top:30px;">
    <button class="action-btn" onclick="logout()" style="background:#dc3545; color:white;">
      <i class="bi bi-box-arrow-right"></i> Logout
    </button>
  </div>
</div>

<script src="main.js"></script>
<script>
let currentTab = 'users';

function showTab(tab) {
  currentTab = tab;
  document.getElementById('usersTab').classList.add('hidden');
  document.getElementById('transactionsTab').classList.add('hidden');
  document.getElementById('pendingTab').classList.add('hidden');
  document.getElementById('withdrawalsTab').classList.add('hidden');
  document.getElementById('upiTab').classList.add('hidden');
  
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  
  if (tab === 'users') {
    document.getElementById('usersTab').classList.remove('hidden');
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
  } else if (tab === 'transactions') {
    document.getElementById('transactionsTab').classList.remove('hidden');
    document.querySelectorAll('.tab-btn')[1].classList.add('active');
  } else if (tab === 'pending') {
    document.getElementById('pendingTab').classList.remove('hidden');
    document.querySelectorAll('.tab-btn')[2].classList.add('active');
  } else if (tab === 'withdrawals') {
    document.getElementById('withdrawalsTab').classList.remove('hidden');
    document.querySelectorAll('.tab-btn')[3].classList.add('active');
    loadWithdrawals();
  } else if (tab === 'upi') {
    document.getElementById('upiTab').classList.remove('hidden');
    document.querySelectorAll('.tab-btn')[4].classList.add('active');
    loadUPIs();
  }
}

async function loadStats() {
  try {
    const data = await apiCall('/admin/stats', 'GET');
    document.getElementById('totalUsers').textContent = data.totalUsers || 0;
    document.getElementById('totalBalance').textContent = '₹' + (data.totalBalance || 0);
    document.getElementById('totalRecharge').textContent = '₹' + (data.totalRecharge || 0);
    document.getElementById('totalWithdraw').textContent = '₹' + (data.totalWithdraw || 0);
  } catch (error) {
    console.error('Failed to load stats:', error);
  }
}

async function loadUsers() {
  try {
    const data = await apiCall('/admin/users', 'GET');
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';
    
    if (data.users && data.users.length > 0) {
      data.users.forEach(user => {
        tbody.innerHTML += `
          <tr>
            <td>${user.id}</td>
            <td>${user.phone}</td>
            <td>₹${parseFloat(user.balance || 0).toFixed(2)}</td>
            <td>₹${parseFloat(user.total_recharge || 0).toFixed(2)}</td>
            <td>₹${parseFloat(user.total_withdraw || 0).toFixed(2)}</td>
            <td>${user.referral_code}</td>
            <td>${new Date(user.created_at).toLocaleDateString()}</td>
          </tr>
        `;
      });
    } else {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No users found</td></tr>';
    }
  } catch (error) {
    console.error('Failed to load users:', error);
    document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:red;">Failed to load users</td></tr>';
  }
}

async function loadTransactions() {
  try {
    const data = await apiCall('/admin/transactions', 'GET');
    const tbody = document.getElementById('transactionsTableBody');
    tbody.innerHTML = '';
    
    if (data.transactions && data.transactions.length > 0) {
      data.transactions.forEach(t => {
        tbody.innerHTML += `
          <tr>
            <td>${t.id}</td>
            <td>${t.user_id}</td>
            <td>${t.type}</td>
            <td>₹${parseFloat(t.amount).toFixed(2)}</td>
            <td><span class="badge ${t.status}">${t.status}</span></td>
            <td>${t.upi_id || '-'}</td>
            <td>${t.utr_number || '-'}</td>
            <td>${new Date(t.created_at).toLocaleDateString()}</td>
          </tr>
        `;
      });
    } else {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No transactions found</td></tr>';
    }
  } catch (error) {
    console.error('Failed to load transactions:', error);
    document.getElementById('transactionsTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center;color:red;">Failed to load transactions</td></tr>';
  }
}

async function loadPending() {
  try {
    const data = await apiCall('/admin/pending', 'GET');
    const tbody = document.getElementById('pendingTableBody');
    tbody.innerHTML = '';
    
    if (data.pending && data.pending.length > 0) {
      data.pending.forEach(t => {
        tbody.innerHTML += `
          <tr>
            <td>${t.id}</td>
            <td>${t.user_id}</td>
            <td>${t.type}</td>
            <td>₹${parseFloat(t.amount).toFixed(2)}</td>
            <td>${t.utr_number || '-'}</td>
            <td>${new Date(t.created_at).toLocaleDateString()}</td>
            <td>
              <button class="action-btn approve" onclick="approvePayment(${t.id})">Approve</button>
              <button class="action-btn reject" onclick="rejectPayment(${t.id})">Reject</button>
            </td>
          </tr>
        `;
      });
    } else {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No pending payments</td></tr>';
    }
  } catch (error) {
    console.error('Failed to load pending:', error);
    document.getElementById('pendingTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:red;">Failed to load pending payments</td></tr>';
  }
}

async function approvePayment(id) {
  if (!confirm('Approve this payment?')) return;
  
  try {
    await apiCall('/admin/approve', 'POST', { transactionId: id });
    alert('Payment approved successfully!');
    loadPending();
    loadStats();
    loadTransactions();
  } catch (error) {
    alert('Failed to approve payment: ' + error.message);
  }
}

async function rejectPayment(id) {
  if (!confirm('Reject this payment?')) return;
  
  try {
    await apiCall('/admin/reject', 'POST', { transactionId: id });
    alert('Payment rejected successfully!');
    loadPending();
    loadStats();
    loadTransactions();
  } catch (error) {
    alert('Failed to reject payment: ' + error.message);
  }
}

async function loadWithdrawals() {
  try {
    const data = await apiCall('/admin/pending-withdrawals', 'GET');
    const tbody = document.getElementById('withdrawalsTableBody');
    tbody.innerHTML = '';
    
    if (data.withdrawals && data.withdrawals.length > 0) {
      data.withdrawals.forEach(w => {
        tbody.innerHTML += `
          <tr>
            <td>${w.id}</td>
            <td>${w.phone}</td>
            <td>₹${parseFloat(w.requested_amount).toFixed(2)}</td>
            <td>${w.upi_id || '-'}</td>
            <td>${new Date(w.created_at).toLocaleDateString()}</td>
            <td>
              <button class="action-btn approve" onclick="approveWithdrawal(${w.id})">
                <i class="bi bi-check-circle"></i> Approve
              </button>
              <button class="action-btn reject" onclick="denyWithdrawal(${w.id})">
                <i class="bi bi-x-circle"></i> Deny
              </button>
            </td>
          </tr>
        `;
      });
    } else {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No pending withdrawals</td></tr>';
    }
  } catch (error) {
    console.error('Failed to load withdrawals:', error);
    document.getElementById('withdrawalsTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:red;">Failed to load withdrawals</td></tr>';
  }
}

async function approveWithdrawal(id) {
  if (!confirm('Approve this withdrawal? The amount will be deducted from the user\'s wallet.')) return;
  
  try {
    await apiCall(`/admin/withdraw/${id}/approve`, 'POST', {});
    alert('Withdrawal approved successfully!');
    loadWithdrawals();
    loadStats();
  } catch (error) {
    alert('Failed to approve withdrawal: ' + error.message);
  }
}

async function denyWithdrawal(id) {
  const reason = prompt('Enter reason for denial (optional):');
  if (reason === null) return;
  
  try {
    await apiCall(`/admin/withdraw/${id}/deny`, 'POST', { reason });
    alert('Withdrawal denied successfully!');
    loadWithdrawals();
  } catch (error) {
    alert('Failed to deny withdrawal: ' + error.message);
  }
}

async function loadUPIs() {
  try {
    const data = await apiCall('/admin/upis', 'GET');
    const tbody = document.getElementById('upiTableBody');
    tbody.innerHTML = '';
    
    if (data.upis && data.upis.length > 0) {
      data.upis.forEach(upi => {
        const statusBadge = upi.is_active ? 
          '<span class="badge completed">ACTIVE</span>' : 
          '<span class="badge pending">Inactive</span>';
        
        tbody.innerHTML += `
          <tr>
            <td>${upi.qr_position}</td>
            <td>${upi.upi_id}</td>
            <td>${upi.successful_payments}</td>
            <td>${upi.max_payments_per_qr}</td>
            <td>${statusBadge}</td>
          </tr>
        `;
      });
    } else {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No UPI IDs found</td></tr>';
    }
  } catch (error) {
    console.error('Failed to load UPIs:', error);
    document.getElementById('upiTableBody').innerHTML = '<tr><td colspan="5" style="text-align:center;color:red;">Failed to load UPI IDs</td></tr>';
  }
}

function logout() {
  localStorage.clear();
  window.location.href = 'admin-login.html';
}

loadStats();
loadUsers();
loadTransactions();
loadPending();

setInterval(() => {
  loadStats();
  if (currentTab === 'users') loadUsers();
  else if (currentTab === 'transactions') loadTransactions();
  else if (currentTab === 'pending') loadPending();
  else if (currentTab === 'withdrawals') loadWithdrawals();
  else if (currentTab === 'upi') loadUPIs();
}, 30000);
</script>
</body>
</html>
